version: '3.8'

services:
  saferoute:
    build: .
    image: saferoute:latest
    container_name: saferoute_gateway
    restart: unless-stopped
    privileged: true
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    ports:
      - "9696:8080"      # Exposed on 9696 to avoid conflicts with 8080
      # - "51820:51820/udp" # WireGuard incoming (uncomment if serving as server)
    environment:
      - CONFIG_DIR=/app/data/configs
      - TZ=UTC
    volumes:
      # Mount your configuration directory here
      - ./data:/app/data/configs
      # Mount kernel modules for WireGuard (optional if using userspace)
      - /lib/modules:/lib/modules
    networks:
      - default
      - proxy # Connect to Traefik network
    labels:
      - "traefik.enable=true"
      # Router configuration
      - "traefik.http.routers.saferoute.rule=Host(`saferoute.local`)" # CHANGE THIS to your domain
      - "traefik.http.routers.saferoute.entrypoints=web"
      - "traefik.http.routers.saferoute.service=saferoute"
      # Service configuration (point to internal port 8080)
      - "traefik.http.services.saferoute.loadbalancer.server.port=8080"

networks:
  proxy:
    external: true
