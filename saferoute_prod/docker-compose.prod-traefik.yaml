

services:
  saferoute:
    # build: . # QNAP/Portainer cannot build from source without files. Use image below.
    image: ghcr.io/linsssbei/saferoute:latest # CHANGE THIS to your actual image
    container_name: saferoute_gateway
    restart: unless-stopped
    privileged: true
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    ports:
      - "9696:8080"      # Exposed on 9696 to avoid conflicts with 8080
      # - "51820:51820/udp" # WireGuard incoming (uncomment if serving as server)
    environment:
      - CONFIG_DIR=/app/data/configs
      - TZ=UTC
    volumes:
      # Mount your configuration directory here
      - ./data:/app/data/configs
      # Mount kernel modules for WireGuard (optional if using userspace)
      - /lib/modules:/lib/modules
    
    # CRITICAL: Use host network for routing functionality
    # NOTE: This means Traefik labels won't work - access UI directly at http://<QNAP-IP>:8080
    network_mode: host
    
    # Traefik labels are commented out because host networking bypasses Docker networks
    # If you need Traefik access, use a reverse proxy on the QNAP host itself (e.g., nginx)
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.http.routers.saferoute.rule=Host(`saferoute.local`)"
    #   - "traefik.http.routers.saferoute.entrypoints=web"
    #   - "traefik.http.routers.saferoute.service=saferoute"
    #   - "traefik.http.services.saferoute.loadbalancer.server.port=8080"

# Networks section removed - using host networking instead
